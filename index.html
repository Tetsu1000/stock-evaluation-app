<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>株式評価ミニアプリ（Vercel静的サイト版）</title>
  <meta name="description" content="Excel読込＋検索自動反映／一覧（投資スコア順）＋株価自動取得。金額は億円、ROEは%対応。" />
  <style>
    :root{--fg:#0f172a;--muted:#64748b;--line:#e2e8f0;--bg:#f8fafc}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(#fff,#f8fafc);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 20px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .grid{display:grid;gap:16px} .main{grid-template-columns:2fr 1fr}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:18px}
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:8px 0;border-bottom:1px solid var(--line);font-size:14px}
    .row.header{color:var(--muted);font-size:12px}
    .muted{color:var(--muted)} .small{font-size:12px}
    input.input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;text-align:right}
    .badge{display:inline-block;padding:6px 12px;border-radius:999px;color:#fff}
  </style>

  <!-- API エンドポイント（必要なら変更可） -->
  <script>window.API_BASE = "https://stock-quote-api-opal.vercel.app";</script>

  <!-- ルート直下の UMD ライブラリ（同じリポジトリの直下に置いてください） -->
  <script src="./react.production.min.js"></script>
  <script src="./react-dom.production.min.js"></script>
  <script src="./xlsx.full.min.js"></script>
</head>
<body>
  <div id="app" class="wrap"><div class="card"><b>読み込み中…</b></div></div>

  <script>
  (function(){
    const {useState,useEffect,useMemo} = React;
    const asArray = (v)=>Array.isArray(v)?v:[]; const clamp=(x,lo=0,hi=100)=>Math.max(lo,Math.min(hi,x));
    const mean=(a)=>{const b=asArray(a).map(Number).filter(x=>Number.isFinite(x));return b.length?b.reduce((s,v)=>s+v,0)/b.length:0};
    const stdev=(a)=>{const b=asArray(a).map(Number).filter(x=>Number.isFinite(x));const m=mean(b);const v=b.length?b.reduce((s,v2)=>s+(v2-m)**2,0)/b.length:0;return Math.sqrt(Math.max(0,v));};
    const median=(a)=>{const b=asArray(a).map(Number).filter(x=>Number.isFinite(x)).sort((x,y)=>x-y);if(!b.length)return 0;const m=Math.floor(b.length/2);return b.length%2?b[m]:(b[m-1]+b[m])/2;};
    const iqr=(a)=>{const b=asArray(a).map(Number).filter(x=>Number.isFinite(x)).sort((x,y)=>x-y);if(b.length<4)return Math.max(1e-9,stdev(b));const q=(p)=>{const pos=(b.length-1)*p;const k=Math.floor(pos);const r=pos-k;return b[k]+r*(b[Math.min(k+1,b.length-1)]-b[k]);};return Math.max(1e-9,q(0.75)-q(0.25));};
    const prettyPct=(x)=>!isFinite(x)?"-":(x*100).toFixed(2)+"%";
    const prettyNum=(x)=>!isFinite(x)?"-":Number(x).toLocaleString(undefined,{maximumFractionDigits:2});
    const toNum=(v)=>{if(v==null||v==="")return 0;const s=String(v).replace(/[\u3000\s,]/g,"");const n=Number(s);return Number.isFinite(n)?n:0;};
    const numberOrEmpty=(v)=>{if(v===""||v==null)return "";const n=Number(String(v).replace(/[\u3000\s,]/g,""));return Number.isFinite(n)?n:"";};
    const parsePercent=(v)=>{if(v==null||v==="")return 0;const s=String(v).trim();if(s.includes("%"))return toNum(s.replace(/%/g,""));const n=toNum(s);return Math.abs(n)<=1?n*100:n;};
    const yearLabels=[2021,2022,2023,2024,2025];
    function linreg(arr){ const y=asArray(arr).map(v=>+v||0); const n=y.length; if(n<2) return {slope:0,intercept:mean(y),se:0};
      const x=Array.from({length:n},(_,i)=>i+1); const mx=mean(x), my=mean(y); let num=0, den=0;
      for(let i=0;i<n;i++){ num+=(x[i]-mx)*(y[i]-my); den+=(x[i]-mx)**2; }
      const slope=den===0?0:num/den; const b=my-slope*mx;
      let sse=0; for(let i=0;i<n;i++){ const fit=slope*x[i] + b; sse+=(y[i]-fit)**2; }
      const se=Math.sqrt(Math.max(0, sse/Math.max(1,n-2))); return {slope,intercept:b,se}; }
    function calcBarrierScore(roe){ const a=asArray(roe); if(a.length<5) return 0; const last=a[4]??0; const slope=linreg(a).slope; return last/3 + slope/10; }

    const QUOTE_API = (window.API_BASE||"") + "/api/quote";
    async function fetchQuote(ticker){
      if(!ticker) return {price:null,source:null}; const tk=String(ticker).trim();
      try{ const r=await fetch(QUOTE_API+"?ticker="+encodeURIComponent(tk),{cache:"no-store"});
        if(r.ok){ const j=await r.json(); const px=Number(j.price);
          if(Number.isFinite(px)) return {price:px,source:j.source?("api("+j.source+")"):"api"}; } }catch(e){}
      try{ const u="https://query1.finance.yahoo.com/v7/finance/quote?symbols="+encodeURIComponent(tk);
        const r=await fetch(u); if(r.ok){ const j=await r.json(); const q=j?.quoteResponse?.result?.[0]??null;
          const px=Number(q?.regularMarketPrice ?? q?.postMarketPrice ?? q?.preMarketPrice ?? q?.regularMarketPreviousClose);
          if(Number.isFinite(px)) return {price:px,source:"yahoo"}; } }catch(e){}
      try{ let s=tk.toLowerCase(); if(s.endsWith(".t")) s=s.replace(/\.t$/,".jp");
        const u=`https://stooq.com/q/l/?s=${encodeURIComponent(s)}&f=sd2t2ohlcv&h&e=csv`;
        const r=await fetch(u); if(r.ok){ const text=await r.text(); const lines=text.trim().split(/\r?\n/);
          if(lines.length>=2){ const head=lines[0].split(","), row=lines[1].split(","); const i=head.findIndex(h=>h.toLowerCase()==="close");
            const px=i>=0?Number(row[i]):Number(row[row.length-2]); if(Number.isFinite(px)) return {price:px,source:"stooq"}; } } }catch(e){}
      return {price:null,source:null};
    }

    function App(){
      const {useState,useEffect,useMemo} = React;
      const [meta,setMeta]=useState({name:"",ticker:"",sector:""});
      const [op,setOp]=useState([0,0,0,0,0]), [fcf,setFcf]=useState([0,0,0,0,0]), [roe,setRoe]=useState([0,0,0,0,0]);
      const [price,setPrice]=useState(0), [shares,setShares]=useState(0);
      const [opPrev,setOpPrev]=useState(0), [opThis,setOpThis]=useState(0), [opNext,setOpNext]=useState(0);
      const [dataset,setDataset]=useState([]), [searchQ,setSearchQ]=useState(""), [quoteStatus,setQuoteStatus]=useState("");

      async function handleExcel(e){
        const file=e.target.files?.[0]; if(!file) return;
        const data=await file.arrayBuffer(); const wb=XLSX.read(data,{type:"array"});
        const ws= wb.Sheets["information"] || wb.Sheets[wb.SheetNames[0]];
        const rows=XLSX.utils.sheet_to_json(ws,{defval:null});
        const list=rows.map((r,idx)=>{
          const op=[2021,2022,2023,2024,2025].map(y=>toNum(r["Op_"+y]));
          const fcf=[2021,2022,2023,2024,2025].map(y=>toNum(r["FCF_"+y]));
          const roe=[2021,2022,2023,2024,2025].map(y=>parsePercent(r["ROE_"+y]));
          return { id:idx+1, name:r.company||"", ticker:String(r.ticker||""), sector:r["業種"]||"", price:toNum(r.price||0), shares:toNum(r.share||0),
                   op, fcf, roe, opPrev:toNum(r["Op_2025"]), opThis:toNum(r["Op_2026"]), opNext:toNum(r["Op_2027"]) };
        }).filter(r=>r.name);
        setDataset(list); if(list.length) setFromRow(list[0]);
      }
      function setFromRow(r){ setMeta({name:r.name||"",ticker:r.ticker||"",sector:r.sector||""}); setOp(asArray(r.op)); setFcf(asArray(r.fcf)); setRoe(asArray(r.roe)); setPrice(toNum(r.price)); setShares(toNum(r.shares)); setOpPrev(toNum(r.opPrev)); setOpThis(toNum(r.opThis)); setOpNext(toNum(r.opNext)); }

      const datasetFiltered=useMemo(()=>{ const q=(searchQ||"").toLowerCase(); return asArray(dataset).filter(r=>(r?.name||"").toLowerCase().includes(q)); },[dataset,searchQ]);
      useEffect(()=>{ if(searchQ && datasetFiltered.length) setFromRow(datasetFiltered[0]); },[searchQ,datasetFiltered]);

      const opReg=linreg(op), opMean=Math.max(1e-9,mean(op)); const slopeDiv=opReg.slope/opMean, seDivRaw=opReg.se/opMean;
      const cohort=useMemo(()=>{
        if(!dataset.length) return null;
        const s1=dataset.map(r=>{ const lr=linreg(r.op||[]); const m=Math.max(1e-9,mean(r.op||[])); return lr.slope/m; });
        const s2i=dataset.map(r=>{ const lr=linreg(r.op||[]); const m=Math.max(1e-9,mean(r.op||[])); return 1/Math.max(1e-9, lr.se/m); });
        const med1=median(s1), I=iqr(s1);
        const rzArr=I===0?s1.map(()=>0.5):s1.map(x=>(x-med1)/I);
        const min1=Math.min(...rzArr), max1=Math.max(...rzArr), min2=Math.min(...s2i), max2=Math.max(...s2i);
        return {med1,I,min1,max1,min2,max2};
      },[dataset]);
      const growthScore=useMemo(()=>{ if(!cohort) return 50; const rz=cohort.I===0?0.5:(slopeDiv-cohort.med1)/cohort.I; const mm=cohort.max1===cohort.min1?0.5:(rz-cohort.min1)/(cohort.max1-cohort.min1); return clamp(mm*100,0,100); },[cohort,slopeDiv]);
      const breScore=useMemo(()=>{ if(!cohort) return 50; const inv=1/Math.max(1e-9,seDivRaw); const mm=cohort.max2===cohort.min2?0.5:(inv-cohort.min2)/(cohort.max2-cohort.min2); return clamp(mm*100,0,100); },[cohort,seDivRaw]);
      const opTrendScore=((growthScore+breScore)/2)*0.15; const fundGenScore=asArray(fcf).filter(x=>(+x||0)>0).length; const barrierScore=calcBarrierScore(roe);
      const investScore=opTrendScore+fundGenScore+barrierScore; const investLabel=investScore<8?"売るべき企業":investScore<10?"様子見企業":investScore<12?"よい企業":"すばらしい企業";

      const seRels=dataset.length?dataset.map(r=>{const lr=linreg(r.op||[]);const m=Math.max(1e-9,mean(r.op||[]));return lr.se/m;}):[seDivRaw];
      const muSe=mean(seRels), sdSe=Math.max(1e-9,stdev(seRels)); const seStd=(seDivRaw-muSe)/sdSe, r=(seStd+7)/100;
      const slopeRels=dataset.length?dataset.map(r=>{const lr=linreg(r.op||[]);const m=Math.max(1e-9,mean(r.op||[]));return lr.slope/m;}):[slopeDiv];
      const muSlope=mean(slopeRels), sdSlope=Math.max(1e-9,stdev(slopeRels)); const slopeStd=(slopeDiv-muSlope)/sdSlope, gN=(slopeStd+2.5)/100;

      const g=useMemo(()=>{ if(opNext>0 && opPrev>0) return Math.sqrt(opNext/opPrev)-1; if(opThis>0 && opPrev>0) return opThis/opPrev-1; return 0; },[opPrev,opThis,opNext]);
      const op5=opPrev*Math.pow(1+g,5), ni5=0.65*op5, denom=Math.max(1e-6, r-gN); const tv5=ni5*(1+gN)/denom, pv=tv5/Math.pow(1+r,5);
      const targetPrice=shares>0?pv/shares:0; const ratio=price>0?targetPrice/price:0; const verdict= ratio>=2?{label:"買い",bg:"#059669"}: ratio>=1?{label:"中立",bg:"#f59e0b"}:{label:"売り",bg:"#e11d48"};

      useEffect(()=>{ const tk=(meta.ticker||"").trim(); if(!tk) return; let cancelled=false; const t=setTimeout(async()=>{ const {price:px,source}=await fetchQuote(tk); if(!cancelled){ if(px!=null) setPrice(px); if(source) setQuoteStatus(source); } }, 200); return ()=>{cancelled=true;clearTimeout(t);} },[meta.ticker]);
      async function refreshPrice(){ const tk=(meta.ticker||"").trim(); if(!tk) return; const {price:px,source}=await fetchQuote(tk); if(px!=null) setPrice(px); if(source) setQuoteStatus(source); }

      function evalAll(ds){
        const s1=ds.map(r=>{const lr=linreg(r.op||[]);const m=Math.max(1e-9,mean(r.op||[]));return lr.slope/m;});
        const s2=ds.map(r=>{const lr=linreg(r.op||[]);const m=Math.max(1e-9,mean(r.op||[]));return lr.se/m;});
        const s2i=s2.map(x=>1/Math.max(1e-9,x));
        const med1=median(s1), I=iqr(s1);
        const rzArr=I===0?s1.map(()=>0.5):s1.map(x=>(x-med1)/I);
        const a1={mn:Math.min(...rzArr), mx:Math.max(...rzArr)}, a2={mn:Math.min(...s2i), mx:Math.max(...s2i)};
        return ds.map(row=>{
          const lr=linreg(row.op||[]); const m=Math.max(1e-9,mean(row.op||[]));
          const slopeDiv=lr.slope/m; const seDiv=lr.se/m;
          const rz=I===0?0.5:(slopeDiv-med1)/I;
          const growth=(a1.mx===a1.mn?0.5:(rz-a1.mn)/(a1.mx-a1.mn))*100;
          const inv=1/Math.max(1e-9,seDiv);
          const bre=(a2.mx===a2.mn?0.5:(inv-a2.mn)/(a2.mx-a2.mn))*100;
          const opTrend=((growth+bre)/2)*0.15;
          const fund=asArray(row.fcf).filter(x=>(+x||0)>0).length;
          const barrier=calcBarrierScore(row.roe||[]);
          const invest=opTrend+fund+barrier;
          const label=invest<8?"売るべき企業": invest<10?"様子見企業": invest<12?"よい企業":"すばらしい企業";
          return { id:row.id, name:row.name, ticker:row.ticker, price:row.price, investScore:invest, investLabel:label, valueLabel:"-" };
        }).sort((a,b)=>b.investScore-a.investScore);
      }
      const lists=useMemo(()=>{ const rs=evalAll(dataset||[]); return { great: rs.filter(r=>r.investScore>=12), good: rs.filter(r=>r.investScore>=10&&r.investScore<12) }; },[dataset]);

      const app = React.createElement('div',null,
        React.createElement('div',{className:'toolbar'},
          React.createElement('div',null, React.createElement('h2',null,'株式評価ミニアプリ（Vercel静的サイト版）'),
            React.createElement('div',{className:'muted small'},'Excel読込＋検索自動反映／一覧（投資スコア順）＋株価自動取得（億円/%）')
          ),
          React.createElement('div',{style:{display:'flex',gap:8,alignItems:'center'}},
            React.createElement('input',{placeholder:'企業名で検索（部分一致）',value:searchQ,onInput:e=>setSearchQ(e.target.value)}),
            React.createElement('input',{type:'file',accept:'.xlsx,.xls',onChange:handleExcel}),
            React.createElement('button',{onClick:refreshPrice},'価格更新')
          )
        ),
        React.createElement('div',{className:'grid main',style:{marginTop:16}},
          React.createElement('div',{className:'card'},
            React.createElement('div',{className:'grid',style:{gap:16}},
              React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12}},
                React.createElement('input',{className:'input',placeholder:'企業名',value:meta.name,onInput:e=>setMeta({...meta,name:e.target.value})}),
                React.createElement('input',{className:'input',placeholder:'ティッカー（例 7203.T）',value:meta.ticker,onInput:e=>setMeta({...meta,ticker:e.target.value})}),
                React.createElement('input',{className:'input',placeholder:'業種（任意）',value:meta.sector,onInput:e=>setMeta({...meta,sector:e.target.value})})
              ),
              React.createElement('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}},
                React.createElement('div',null,
                  React.createElement('div',null,'過去5年 営業利益（億円）'),
                  React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8,color:'#64748b',fontSize:12,margin:'4px 0'}},[2021,2022,2023,2024,2025].map(y=>React.createElement('div',{key:y,style:{textAlign:'center'}},y))),
                  React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8}}, asArray([].concat(op)).map((v,i)=>React.createElement('input',{key:i,className:'input',value:v??'',placeholder:String([2021,2022,2023,2024,2025][i]),onInput:e=>setOp(a=>a.map((x,j)=>i===j?numberOrEmpty(e.target.value):x))})))
                ),
                React.createElement('div',null,
                  React.createElement('div',null,'過去5年 FCF（億円）'),
                  React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8,color:'#64748b',fontSize:12,margin:'4px 0'}},[2021,2022,2023,2024,2025].map(y=>React.createElement('div',{key:y,style:{textAlign:'center'}},y))),
                  React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8}}, asArray([].concat(fcf)).map((v,i)=>React.createElement('input',{key:i,className:'input',value:v??'',placeholder:String([2021,2022,2023,2024,2025][i]),onInput:e=>setFcf(a=>a.map((x,j)=>i===j?numberOrEmpty(e.target.value):x))})))
                ),
                React.createElement('div',null,
                  React.createElement('div',null,'過去5年 ROE'),
                  React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8,color:'#64748b',fontSize:12,margin:'4px 0'}},[2021,2022,2023,2024,2025].map(y=>React.createElement('div',{key:y,style:{textAlign:'center'}},y))),
                  React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:8}}, asArray([].concat(roe)).map((v,i)=>React.createElement('div',{key:i,style:{position:'relative'}},
                    React.createElement('input',{className:'input',style:{paddingRight:28},value:v??'',placeholder:String([2021,2022,2023,2024,2025][i]),onInput:e=>setRoe(a=>a.map((x,j)=>i===j?numberOrEmpty(e.target.value):x))}),
                    React.createElement('span',{style:{position:'absolute',right:10,top:'50%',transform:'translateY(-50%)',color:'#94a3b8'}},'%')
                  )))
                )
              ),
              React.createElement('div',{style:{display:'grid',gridTemplateColumns:'repeat(5,1fr)',gap:16}},
                React.createElement('div',null,
                  React.createElement('div',null,'株価（円）'),
                  React.createElement('input',{className:'input',value:price,onInput:e=>setPrice(numberOrEmpty(e.target.value)),placeholder:'例 3500'}),
                  React.createElement('div',{className:'small muted'}, '自動取得: ', quoteStatus || '-', meta.ticker?React.createElement('a',{href:'https://finance.yahoo.co.jp/quote/'+encodeURIComponent(String(meta.ticker).trim()),target:'_blank',style:{marginLeft:6}},'Yahooで見る'):null)
                ),
                React.createElement('div',null,React.createElement('div',null,'普通株式数（株）'),React.createElement('input',{className:'input',value:shares,onInput:e=>setShares(numberOrEmpty(e.target.value)),placeholder:'例 1,000,000,000'})),
                React.createElement('div',null,React.createElement('div',null,'前期OP（億円）'),React.createElement('input',{className:'input',value:opPrev,onInput:e=>setOpPrev(numberOrEmpty(e.target.value)),placeholder:'Op_2025'})),
                React.createElement('div',null,React.createElement('div',null,'今期OP予想（億円）'),React.createElement('input',{className:'input',value:opThis,onInput:e=>setOpThis(numberOrEmpty(e.target.value)),placeholder:'Op_2026'})),
                React.createElement('div',null,React.createElement('div',null,'来期OP予想（億円 任意）'),React.createElement('input',{className:'input',value:opNext,onInput:e=>setOpNext(numberOrEmpty(e.target.value)),placeholder:'Op_2027'}))
              )
            )
          ),
          React.createElement('div',{className:'grid',style:{gap:16}},
            React.createElement('div',{className:'card',style:{display:'flex',justifyContent:'space-between',alignItems:'center'}},
              React.createElement('div',null,
                React.createElement('div',{className:'muted small'},'投資スコア（魅力度の合計）'),
                React.createElement('div',{style:{fontSize:36,fontWeight:700}}, (opTrendScore+fundGenScore+calcBarrierScore(roe)).toFixed(2)),
                React.createElement('div',{className:'small muted'}, '営業トレンド ', (opTrendScore).toFixed(2), ' / 資金創出 ', (asArray(fcf).filter(x=>(+x||0)>0).length).toFixed(2), ' / 参入障壁 ', (calcBarrierScore(roe)).toFixed(2))
              ),
              (function(){
                const investScore = opTrendScore+fundGenScore+calcBarrierScore(roe);
                const label = investScore<8?'売るべき企業':investScore<10?'様子見企業':investScore<12?'よい企業':'すばらしい企業';
                const bg = investScore<8?'#e11d48':investScore<10?'#f59e0b':investScore<12?'#10b981':'#047857';
                return React.createElement('div',null,
                  React.createElement('span',{className:'badge',style:{background:bg}}, label),
                  React.createElement('div',{className:'small muted',style:{textAlign:'right',marginTop:4}},'基準: 8 / 10 / 12')
                );
              })()
            ),
            React.createElement('div',{className:'card'},
              (function(){
                const seRels=dataset.length?dataset.map(r=>{const lr=linreg(r.op||[]);const m=Math.max(1e-9,mean(r.op||[]));return lr.se/m;}):[seDivRaw];
                const muSe=mean(seRels), sdSe=Math.max(1e-9,stdev(seRels)); const seStd=(seDivRaw-muSe)/sdSe, r=(seStd+7)/100;
                const slopeRels=dataset.length?dataset.map(r=>{const lr=linreg(r.op||[]);const m=Math.max(1e-9,mean(r.op||[]));return lr.slope/m;}):[slopeDiv];
                const muSlope=mean(slopeRels), sdSlope=Math.max(1e-9,stdev(slopeRels)); const slopeStd=(slopeDiv-muSlope)/sdSlope, gN=(slopeStd+2.5)/100;
                const g = (opNext>0 && opPrev>0) ? Math.sqrt(opNext/opPrev)-1 : (opThis>0 && opPrev>0) ? (opThis/opPrev-1) : 0;
                const op5=opPrev*Math.pow(1+g,5), ni5=0.65*op5, denom=Math.max(1e-6, r-gN); const tv5=ni5*(1+gN)/denom, pv=tv5/Math.pow(1+r,5);
                const targetPrice=shares>0?pv/shares:0; const ratio=price>0?targetPrice/price:0; const verdict= ratio>=2?{label:"買い",bg:"#059669"}: ratio>=1?{label:"中立",bg:"#f59e0b"}:{label:"売り",bg:"#e11d48"};
                return React.createElement('div',{className:'grid',style:{gridTemplateColumns:'1fr 1fr',gap:12}},
                  React.createElement('div',null,React.createElement('div',{className:'small muted'},'年平均成長率 g'),React.createElement('div',{style:{fontSize:20,fontWeight:700}}, prettyPct(g))),
                  React.createElement('div',null,React.createElement('div',{className:'small muted'},'期待収益率 r'),React.createElement('div',{style:{fontSize:20,fontWeight:700}}, prettyPct(r))),
                  React.createElement('div',null,React.createElement('div',{className:'small muted'},'成長率（標準化）'),React.createElement('div',{style:{fontSize:20,fontWeight:700}}, prettyPct(gN))),
                  React.createElement('div',null,React.createElement('div',{className:'small muted'},'目標株価'),React.createElement('div',{style:{fontSize:20,fontWeight:700}}, prettyNum(targetPrice))),
                  React.createElement('div',null,React.createElement('div',{className:'small muted'},'現在株価'),React.createElement('div',{style:{fontSize:20,fontWeight:700}}, prettyNum(price))),
                  React.createElement('div',null,React.createElement('div',{className:'small muted'},'判定'),
                    React.createElement('div',{style:{fontSize:20,fontWeight:700}}, React.createElement('span',{className:'badge',style:{background:verdict.bg}}, verdict.label))
                  ),
                  React.createElement('div',{className:'small muted',style:{gridColumn:'1 / -1'}}, '注：r=(標準化SE+7)/100、g=(標準化傾き+2.5)/100。参入障壁は 昨期ROE[%]/3 + 5年傾き/10。株価取得は /api/quote → Yahoo → Stooq の順。')
                );
              })()
            ),
            React.createElement('div',{className:'card'},
              React.createElement('div',{className:'muted small',style:{marginBottom:8}},'一覧（投資スコア降順）'),
              React.createElement('div',{className:'row header'},React.createElement('div',null,'社名'),React.createElement('div',null,'投資スコア'),React.createElement('div',null,'現在株価'),React.createElement('div',null,'割安度判定')),
              (function(){
                const rs = (dataset && dataset.length) ? (function evalAll(ds){
                  const s1=ds.map(r=>{const lr=linreg(r.op||[]);const m=Math.max(1e-9,mean(r.op||[]));return lr.slope/m;});
                  const s2=ds.map(r=>{const lr=linreg(r.op||[]);const m=Math.max(1e-9,mean(r.op||[]));return lr.se/m;});
                  const s2i=s2.map(x=>1/Math.max(1e-9,x));
                  const med1=median(s1), I=iqr(s1);
                  const rzArr=I===0?s1.map(()=>0.5):s1.map(x=>(x-med1)/I);
                  const a1={mn:Math.min(...rzArr), mx:Math.max(...rzArr)}, a2={mn:Math.min(...s2i), mx:Math.max(...s2i)};
                  return ds.map(row=>{
                    const lr=linreg(row.op||[]); const m=Math.max(1e-9,mean(row.op||[]));
                    const slopeDiv=lr.slope/m; const seDiv=lr.se/m;
                    const rz=I===0?0.5:(slopeDiv-med1)/I;
                    const growth=(a1.mx===a1.mn?0.5:(rz-a1.mn)/(a1.mx-a1.mn))*100;
                    const inv=1/Math.max(1e-9,seDiv);
                    const bre=(a2.mx===a2.mn?0.5:(inv-a2.mn)/(a2.mx-a2.mn))*100;
                    const opTrend=((growth+bre)/2)*0.15;
                    const fund=asArray(row.fcf).filter(x=>(+x||0)>0).length;
                    const barrier=calcBarrierScore(row.roe||[]);
                    const invest=opTrend+fund+barrier;
                    const label=invest<8?"売るべき企業": invest<10?"様子見企業": invest<12?"よい企業":"すばらしい企業";
                    return { id:row.id, name:row.name, ticker:row.ticker, price:row.price, investScore:invest, investLabel:label, valueLabel:"-" };
                  }).sort((a,b)=>b.investScore-a.investScore);
                })(dataset) : [];
                return rs.length? rs.map(r=>React.createElement('div',{key:r.id,className:'row'},React.createElement('div',null,r.name),React.createElement('div',null,r.investScore.toFixed(2)),React.createElement('div',null,prettyNum(r.price)),React.createElement('div',null,r.valueLabel))) : React.createElement('div',{className:'small muted',style:{padding:'8px 0'}},'該当なし');
              })()
            )
          )
        )
      );
      ReactDOM.createRoot(document.getElementById("app")).render(app);
    })();
  </script>
</body>
</html>
