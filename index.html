<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>株式評価ミニアプリ（CDN冗長化版）</title>
  <style>
    :root{--fg:#0f172a;--muted:#64748b;--line:#e2e8f0;--bg:#f8fafc}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(#fff,#f8fafc);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 20px}
    pre{white-space:pre-wrap;background:#fff;border:1px solid var(--line);padding:12px;border-radius:10px}
  </style>
  <script>window.API_BASE="https://stock-quote-api-opal.vercel.app";</script>
</head>
<body>
  <div id="app" class="wrap">
    <div id="msg">読み込み中…</div>
    <details style="margin-top:12px"><summary>ログ</summary><pre id="log"></pre></details>
  </div>
  <script>
    const logEl = document.getElementById('log');
    function log(...a){ console.log(...a); logEl.textContent += a.join(' ') + '\\n'; }

    const cdns = {
      react: [
        'https://unpkg.com/react@18/umd/react.production.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js'
      ],
      reactdom: [
        'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js'
      ],
      xlsx: [
        'https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js'
      ]
    };

    function loadScript(src){ 
      return new Promise((resolve,reject)=>{
        const s = document.createElement('script');
        s.src = src; s.async=false; s.onload=()=>resolve(src); s.onerror=()=>reject(new Error('load fail '+src));
        document.head.appendChild(s);
      });
    }

    async function loadWithFallback(list, checkFn, name){
      for (const url of list){
        try{ log('try', name, url); await loadScript(url); await new Promise(r=>setTimeout(r,100)); if(checkFn()){ log('ok', name, url); return true; } } 
        catch(e){ log('err', name, url, e.message); }
      }
      return false;
    }

    (async () => {
      const okReact = await loadWithFallback(cdns.react, ()=>!!window.React, 'react');
      const okDom   = await loadWithFallback(cdns.reactdom, ()=>!!window.ReactDOM, 'react-dom');
      const okXlsx  = await loadWithFallback(cdns.xlsx, ()=>!!window.XLSX, 'xlsx');
      const msgEl = document.getElementById('msg');
      if (okReact && okDom && okXlsx){
        msgEl.textContent = 'ライブラリ読込OK（React/ReactDOM/XLSX）— この直下にアプリ本体スクリプトを貼れば動作します。';
      } else {
        msgEl.textContent = 'ライブラリの読み込みに失敗（ネットワーク/フィルタでCDNがブロックされている可能性）';
      }
    })();
  </script>
</body>
</html>
